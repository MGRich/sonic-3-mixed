object 0x57;

event Create() {
    Active = true;
    Priority = true;

    var PlatformType:int = SubType >> 4;

    W = 64;
    H = 128;
    if (PlatformType == 0) {
        W = 0x80;
        H = 0x40;
    }

    Solid = true;
    Scene.AddSelfToRegistry(this, "Solid");
}

event Update() {
    if (PlatformType > 0) {
        if (Scene.RoutineNumber - 1 == (SubType & 0xF)) {
            Scene.ShakeTimer = 0;
            if (FlipX) {
                if (Y + (SubType & 0xF0) * 4 > InitialY) {
                    Y -= SubType >> 4;
                    Scene.ShakeTimer = -1;

                    if (!(Scene.Frame & 0xF)) {
                        Sound::Play(Sound::SFX_RUMBLE);
                    }
                }
                else if (Y == InitialY - (SubType & 0xF0) * 4) {
                    Scene.RoutineNumber &= 0xFFF0;
                }
            }
            else {
                if (Y < InitialY + (SubType & 0xF0) * 4) {
                    Y += SubType >> 4;
                    Scene.ShakeTimer = -1;

                    if (!(Scene.Frame & 0xF)) {
                        Sound::Play(Sound::SFX_RUMBLE);
                    }
                }
                else if (Y == InitialY + (SubType & 0xF0) * 4) {
                    Scene.RoutineNumber &= 0xFFF0;
                }
            }
        }
        if (Scene.RoutineNumber - 1 != (SubType & 0xF) && Math.abs(X - Scene.Player.EZX) >= 0x1D0) {
            Y = InitialY;
        }
    }
    else {
        if (Scene.RoutineNumber - 1 == (SubType & 0xF)) {
            Scene.ShakeTimer = 0;
            if (FlipX) {
                if (X > InitialX - 0x80) {
                    X -= 2;
                    Scene.ShakeTimer = -1;

                    if (!(Scene.Frame & 0xF)) {
                        Sound::Play(Sound::SFX_RUMBLE);
                    }
                }
                else if (X == InitialX - 0x80) {
                    Scene.RoutineNumber &= 0xFF0F;
                    Active = false;
                }
            }
            else {
                if (X < InitialX + 0x80) {
                    X += 2;
                    Scene.ShakeTimer = -1;

                    if (!(Scene.Frame & 0xF)) {
                        Sound::Play(Sound::SFX_RUMBLE);
                    }
                }
                else if (X == InitialX + 0x80) {
                    Scene.RoutineNumber &= 0xFFF0;
                    Active = false;
                }
            }
        }
    }
}

event Render(CamX:int, CamY:int) {
    G.DrawSprite(Sprite, 6, Math.sign(PlatformType), X - CamX, Y - CamY, 0, FlipY ? IE_FLIPY : IE_NOFLIP);
}
